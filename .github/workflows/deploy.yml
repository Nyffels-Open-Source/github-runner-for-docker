name: Release to docker
on:
  workflow_dispatch:
  push:
    branches: ['main']

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  get_version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ env.VERSION }}
    steps:
      - name: Set Calver Version
        uses: Nyffels-IT/github-actions-calver-version-generator@v1.0.1

      - name: Current verion
        run: 'echo Version: ${{ env.VERSION }}'

  get_runner_version:
    runs-on: ubuntu-latest
    outputs:
      runner_version: ${{ steps.extract.outputs.version }}
    steps:
      - name: Fetch latest GitHub Actions runner version
        id: extract
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # optioneel, verhoogt rate limit
        run: |
          echo "ðŸ” Fetching GitHub Actions runner releases..."
          response=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" https://api.github.com/repos/actions/runner/releases)

          if echo "$response" | jq empty >/dev/null 2>&1; then
            version=$(echo "$response" | jq -r '[.[] | select(.prerelease == false and .draft == false)][0].tag_name' | tr -d 'v')
            echo "âœ… Latest Runner Version: $version"
            echo "version=$version" >> "$GITHUB_OUTPUT"
          else
            echo "âŒ Failed to fetch valid JSON from GitHub API:"
            echo "$response"
            exit 1
          fi

  deploy-qa:
    runs-on: ubuntu-latest
    needs: [get_version, get_runner_version]
    steps:
      - name: Copy Repo Files
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          pull: true
          push: true
          sbom: true
          provenance: mode=max
          build-args: |
            RUNNER_VERSION=${{ needs.get_runner_version.outputs.runner_version }}
          tags: |
            nyffels/github-runner:qa-${{ needs.get_version.outputs.version }}

  scan-trivy:
    name: "Security: Trivy"
    runs-on: ubuntu-latest
    needs: [deploy-qa, get_version]
    env:
      IMAGE_REF: nyffels/github-runner:qa-${{ needs.get_version.outputs.version }}
    steps:
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Pull image
        run: docker pull $IMAGE_REF

      - name: Blocking
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: ${{ env.IMAGE_REF }}
          severity: CRITICAL,HIGH
          exit-code: "1"

  scan-trivy-non-blocking:
    name: "Security: Trivy (non-blocking)"
    runs-on: ubuntu-latest
    continue-on-error: true
    needs: [deploy-qa, get_version]
    env:
      IMAGE_REF: nyffels/github-runner:qa-${{ needs.get_version.outputs.version }}
    steps:
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Pull image
        run: docker pull $IMAGE_REF

      - name: Scan non-blocking
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: ${{ env.IMAGE_REF }}
          severity: LOW,MEDIUM
          exit-code: "1"

  scan-scout:
    name: "Security: Docker Scout"
    runs-on: ubuntu-latest
    needs: [deploy-qa, get_version]
    env:
      IMAGE_REF: nyffels/github-runner:qa-${{ needs.get_version.outputs.version }}
      SCOUT_TEMP_ALLOW_UNTIL: "2026-04-15"
    steps:
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Pull image
        run: docker pull $IMAGE_REF

      - name: Install Docker Scout
        run: |
          curl -fsSL https://raw.githubusercontent.com/docker/scout-cli/main/install.sh | sh
          docker scout version

      - name: Blocking
        shell: bash
        run: |
          set -euo pipefail

          ALLOWED_CVES=("CVE-2025-68121" "CVE-2025-61726")
          TODAY="$(date -u +%F)"
          if [[ "$TODAY" > "$SCOUT_TEMP_ALLOW_UNTIL" ]]; then
            ALLOWED_CVES=()
            echo "Temporary Scout allowlist expired on ${SCOUT_TEMP_ALLOW_UNTIL}."
          else
            echo "Temporary Scout allowlist active until ${SCOUT_TEMP_ALLOW_UNTIL}."
          fi

          docker scout cves "$IMAGE_REF" --only-severity critical,high --format sarif > scout.sarif || true

          ALLOWED_JSON="$(printf '%s\n' "${ALLOWED_CVES[@]}" | jq -R . | jq -s .)"
          BLOCKING_COUNT="$(jq --argjson allowed "$ALLOWED_JSON" '[.runs[].results[]? | select((.ruleId as $id | $allowed | index($id)) | not)] | length' scout.sarif)"

          if [[ "$BLOCKING_COUNT" -gt 0 ]]; then
            echo "Blocking critical/high CVEs found (excluding temporary allowlist):"
            jq -r --argjson allowed "$ALLOWED_JSON" '.runs[].results[]? | select((.ruleId as $id | $allowed | index($id)) | not) | .ruleId' scout.sarif | sort -u
            exit 1
          fi

          echo "No blocking critical/high CVEs outside temporary allowlist."

  scan-scout-non-blocking:
    name: "Security: Docker Scout (non-blocking)"
    runs-on: ubuntu-latest
    continue-on-error: true
    needs: [deploy-qa, get_version]
    env:
      IMAGE_REF: nyffels/github-runner:qa-${{ needs.get_version.outputs.version }}
    steps:
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Pull image
        run: docker pull $IMAGE_REF

      - name: Install Docker Scout
        run: |
          curl -fsSL https://raw.githubusercontent.com/docker/scout-cli/main/install.sh | sh
          docker scout version

      - name: Scan non-blocking
        shell: bash
        run: |
          set -euo pipefail
          docker scout cves "$IMAGE_REF" --only-severity medium,low --format sarif > scout-nonblocking.sarif || true

      - name: Non-blocking gate (soft-fail)
        shell: bash
        run: |
          set -euo pipefail
          NON_BLOCKING_COUNT="$(jq '[.runs[].results[]?] | length' scout-nonblocking.sarif)"
          echo "Docker Scout non-blocking findings count: ${NON_BLOCKING_COUNT}"
          if [[ "$NON_BLOCKING_COUNT" -gt 0 ]]; then
            echo "Docker Scout non-blocking findings detected: ${NON_BLOCKING_COUNT}"
            jq -r '.runs[].results[]? | "\(.ruleId // "n/a") | \((.message.text // "n/a") | gsub("[\r\n]+"; " "))"' scout-nonblocking.sarif | sort -u
            exit 1
          else
            echo "No non-blocking Docker Scout findings."
          fi

  deploy:
    runs-on: ubuntu-latest
    needs: [get_version, scan-trivy, scan-scout]
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Tag and push to DockerHub
        run: |
          docker pull nyffels/github-runner:qa-${{ needs.get_version.outputs.version }}
          
          docker tag nyffels/github-runner:qa-${{ needs.get_version.outputs.version }} nyffels/github-runner:${{ needs.get_version.outputs.version }}
          docker push nyffels/github-runner:${{ needs.get_version.outputs.version }}

          docker tag nyffels/github-runner:qa-${{ needs.get_version.outputs.version }} nyffels/github-runner:latest
          docker push nyffels/github-runner:latest
